<div class="container-fluid" id="toolbar">
    <div class="pull-left">
        @if (ViewBag.ShowAddButton != false)
        {
            <button class="btn btn-primary btn-sm no-border" id="btn_add">
                <i class="fa fa-plus"></i> @this.T("Add")
            </button>
        }
        @if (IsSectionDefined("tools"))
        {
            @RenderSection("tools", required: false)
        }
    </div>

    @Html.Partial("_nav-search")
    <div class="pull-right">
        @if (IsSectionDefined("righttools"))
        {
            @RenderSection("righttools", required: false)
        }
    </div>
</div>
<div>
    <table id="grid_list"></table>
    <div id="grid_list_pager"></div>
</div>
<div class="modal fade" id="editmodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="lbl_title"><i class="fa fa-plus"></i> @this.T("Add")</h4>
            </div>
            <div class="modal-body">
                @RenderSection("form", required: true)
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm no-border" data-dismiss="modal"><i class="fa fa-close"></i> Close</button>
                <button type="button" class="btn btn-primary btn-sm no-border" id="btn_save" data-form="#editform">
                    <i class="fa fa-floppy-o"></i> Save
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
@RenderBody()
<script>
    window.gridComplete = null;
    window.init = null;
    window.onEdit = null;
    window.onAdd = null;
    window.onSaved = null;
    window.seaching = "";
</script>
@RenderSection("init_scripts", required: true)
<script>
    var action = "";
    var selectedId = 0;
    var $grid, $modal;
    function _edit(id) {
        selectedId = id;
        $grid.jqGrid('setSelection', id).jqGrid("editSelectedRow", function (rowData) {
            if (window.onEdit) {
                var ret = window.onEdit(rowData);
                if (ret) rowData = ret;
                else if (ret === false) return;
            }
            action = "edit";
            clearValidationError();
            loadData(rowData);
            $("#lbl_title").html('<i class="fa fa-pencil"></i> @this.T("Edit")');
            $modal.modal("show");
        });
    }
    function _delete(id) {
        $("#grid_list").jqGrid('setSelection', id).jqGrid("delSelectedRow", function (rowData, selectedId, callback) {
            action = "delete";
            $.post("@ViewBag.DeleteUrl", rowData, function (ret) {
                callback(ret);
            });
        });
    }
    $LAB.script(js("jqgrid", "validate"))
        .wait(function () {
            if (window.init) init();
            $(window).on('resize.jqGrid', function () {
                $grid.jqGrid('setGridWidth', $(".page-content").width());
            });

            if (window.colModel) { // 禁止列排序 列上指定 sortable:true 的不会被禁止
                for (var i = 0; i < window.colModel.length; i++) {
                    var col = window.colModel[i];
                    if (col.sortable !== true) {
                        col.sortable = false;
                    }
                }
            }
            $grid = initJqGrid("#grid_list", {
                url: "@ViewBag.GetListUrl",
                //pager: null,
                colModel: window.colModel || [],
                gridComplete: window.gridComplete || function () {
                    var ids = $grid.jqGrid('getDataIDs');
                    for (var i = 0; i < ids.length; i++) {
                        var cl = ids[i];
                        var cellData = '';
                        var hasSave = '@(ViewBag.SaveUrl != null)' == 'True';
                        cellData += hasSave ? '<button class="btn btn-xs btn-primary no-border btn-edit" type="button" data-rowid="' + cl + '"><i class="fa fa-pencil"></i> Edit</button>' : '';
                        cellData += '<button class="btn btn-xs btn-danger no-border btn-del" type="button" data-rowid="' + cl + '"><i class="fa fa-close"></i> Delete</button>';
                        //$grid.jqGrid('setRowData', ids[i], { act: cellData });
                        var ind = $(this).jqGrid('getGridRowById', ids[i]);
                        $("td[role='gridcell']:eq(1)", ind).html(cellData);
                    }
                }
            });

            $modal = $("#editmodal").modal({ show: false });
            $("#nav-search-input").keydown(function (e) {
                if (e.keyCode == 13) {
                    var postData = { search: $("#nav-search-input").val() };
                    if (window.seaching) {
                        var ret = window.seaching(postData);
                        if (ret) postData = ret;
                    }
                    $grid.jqGrid("setGridParam", { postData: postData, page: 1 })
                        .trigger("reloadGrid");
                    return false;
                }
            });

            $("#btn_add").on("click", function () {
                action = "add";
                var data = window.emptyData || {}
                if (window.onAdd) {
                    var ret = window.onAdd(data);
                    if (ret) data = ret;
                    else if (ret === false) return;
                }
                loadData(data);
                $("#lbl_title").html('<i class="fa fa-plus"></i> @this.T("Add")');
                $modal.modal("show");
            });
            $("#grid_list").on("click", ".btn-edit", function () {
                _edit($(this).data("rowid"));
            });
            $("#grid_list").on("click", ".btn-del", function () {
                _delete($(this).data("rowid"));
            });
            submitForm("#btn_save", "@ViewBag.SaveUrl", function (ret) {
                $modal.modal("hide");
                if (window.onSaved) { // 保存后前台绑定数据的拦截方法 返回 false 为拦截
                    var data = window.onSaved(action, ret.value);
                    if (data === false) return;
                    else if (data != undefined) ret.value = data;
                }
                if (action == "add") {
                    $grid.jqGrid("addRow", ret, '');
                } else if (action == "edit") {
                    $grid.jqGrid("setRowData", selectedId, ret.value);
                }
            });
        });
</script>
